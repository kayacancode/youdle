# GitHub Actions workflow for analyzing feedback and learning
# This workflow runs weekly to analyze feedback patterns and refine prompts

name: Feedback Analysis

on:
  # Run weekly on Mondays at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Clean install to avoid namespace package conflicts with google.*
          pip uninstall -y google google-cloud google-api-core || true
          pip install --no-cache-dir -r requirements.txt
          # Verify google-genai SDK is importable
          python -c "from google import genai; from google.genai import types; print('âœ“ google-genai SDK imported successfully')"
      
      - name: Analyze feedback patterns
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python -c "
          from feedback_collector import FeedbackCollector
          from prompt_refiner import PromptRefiner
          from learning_memory import LearningMemory
          import json

          # Get feedback summary
          collector = FeedbackCollector()
          summary = collector.get_feedback_summary()
          
          print('=== Feedback Summary ===')
          print(json.dumps(summary, indent=2))
          
          # Get performance trends
          memory = LearningMemory()
          performance = memory.get_performance_summary()
          
          print('\n=== Performance Summary ===')
          print(json.dumps(performance, indent=2, default=str))
          
          # Generate prompt refinements
          refiner = PromptRefiner()
          additions = refiner.generate_prompt_additions('shoppers')
          
          print('\n=== Prompt Refinements ===')
          for i, addition in enumerate(additions, 1):
              print(f'{i}. {addition}')
          "
      
      - name: Generate learning report
        run: |
          echo "## Weekly Learning Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Feedback analysis completed. Check the logs for details." >> $GITHUB_STEP_SUMMARY



